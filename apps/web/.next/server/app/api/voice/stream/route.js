"use strict";(()=>{var e={};e.id=5664,e.ids=[5664],e.modules={524:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},4074:e=>{e.exports=require("perf_hooks")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},56428:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>b,originalPathname:()=>k,requestAsyncStorage:()=>v,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>g});var o={};r.r(o),r.d(o,{GET:()=>GET,POST:()=>POST});var n=r(10884),a=r(16132),s=r(27418),i=r(37058),c=r(786),p=r(65215),u=r(14333),d=r(37552),l=r(1345);let m=null;function initWebSocketServer(){return m||(m=new s.u9({noServer:!0})).on("connection",(e,t)=>{u.k.info("WebSocket client connected",{component:"voice-stream"});let r=[],o=!1,n="",a=null,s=new p.P;e.on("message",async t=>{try{let p=JSON.parse(t.toString());switch(p.type){case"audio_chunk":let d=Buffer.from(p.data,"base64");if(r.push(d),r.length>=20&&!o){o=!0;try{let t=Buffer.concat(r);r=[];let o=await (0,i.KR)(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength));if(n+=" "+o,e.send(JSON.stringify({type:"transcription",text:o,timestamp:Date.now()})),o.trim().length>10){let t=await s.process(o,{conversationContext:n,encounterId:a});if(e.send(JSON.stringify({type:"ai_response",text:t.text,cards:t.cards,timestamp:Date.now()})),t.text){let r=await (0,c.FI)(t.text);e.send(JSON.stringify({type:"audio_response",audio:r.toString("base64"),timestamp:Date.now()}))}a?await updateConversationInDatabase(a,o,t):(a=crypto.randomUUID(),await saveConversationToDatabase(a,o,t))}}catch(t){u.k.error("Error processing audio chunk",t,{component:"voice-stream"}),e.send(JSON.stringify({type:"error",error:"Failed to process audio",timestamp:Date.now()}))}finally{o=!1}}break;case"start_conversation":a=crypto.randomUUID(),n="",r=[],e.send(JSON.stringify({type:"conversation_started",encounterId:a,timestamp:Date.now()}));break;case"end_conversation":a&&await finalizeConversation(a,n),e.send(JSON.stringify({type:"conversation_ended",timestamp:Date.now()}));break;default:u.k.warn("Unknown message type",{component:"voice-stream",type:p.type})}}catch(t){u.k.error("Error processing WebSocket message",t,{component:"voice-stream"}),e.send(JSON.stringify({type:"error",error:"Failed to process message",timestamp:Date.now()}))}}),e.on("close",()=>{u.k.info("WebSocket client disconnected",{component:"voice-stream"}),a&&finalizeConversation(a,n).catch(e=>{u.k.error("Error finalizing conversation",e,{component:"voice-stream"})})}),e.on("error",e=>{u.k.error("WebSocket error",e,{component:"voice-stream"})})}),m}async function saveConversationToDatabase(e,t,r){try{let e=await (0,l.n5)();if(!e)return;await d.db.insert(d.qU).values({workspaceId:"default",ownerId:e,kind:"voice_conversation",summary:t.substring(0,100)+"...",occurredAt:new Date,raw:{transcript:t}});let r=await (0,i.iS)(t,i.Ax.people,"Extract all people mentioned in this conversation.");if(r?.people)for(let t of r.people){let r=crypto.randomUUID();await d.db.insert(t).values({id:r,workspaceId:"default",ownerId:e,fullName:t.fullName,primaryEmail:t.email||null,createdAt:new Date,updatedAt:new Date}),t.role&&await d.db.insert(d.QS).values({id:crypto.randomUUID(),workspaceId:"default",ownerId:e,subjectType:"person",subjectId:r,key:"role",value:t.role,confidence:85,source:"voice_conversation",lawfulBasis:"legitimate_interest",observedAt:new Date})}}catch(e){u.k.error("Error saving conversation to database",e,{component:"voice-stream"})}}async function updateConversationInDatabase(e,t,r){try{u.k.info("Updating conversation in database",{component:"voice-stream",encounterId:e,transcriptLength:t.length})}catch(e){u.k.error("Error updating conversation in database",e,{component:"voice-stream"})}}async function finalizeConversation(e,t){try{u.k.info("Finalizing conversation",{component:"voice-stream",encounterId:e,contextLength:t.length})}catch(e){u.k.error("Error finalizing conversation",e,{component:"voice-stream"})}}async function GET(e){try{if(initWebSocketServer(),"websocket"===e.headers.get("upgrade"))return new Response("WebSocket upgrade not supported in this environment",{status:400});return new Response("WebSocket endpoint",{status:200})}catch(e){return u.k.error("WebSocket handler error",e,{component:"voice-stream"}),new Response("Internal server error",{status:500})}}async function POST(e){try{let{audioData:t,type:r}=await e.json();if("audio_chunk"===r){let e=Buffer.from(t,"base64"),r=await (0,i.KR)(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),o=new p.P,n=await o.process(r,{}),a=await (0,c.FI)(n.text);return Response.json({type:"response",transcript:r,aiResponse:n.text,audioResponse:a.toString("base64")})}return Response.json({error:"Invalid request type"},{status:400})}catch(e){return u.k.error("Voice stream POST error",e,{component:"voice-stream"}),Response.json({error:"Internal server error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/voice/stream/route",pathname:"/api/voice/stream",filename:"route",bundlePath:"app/api/voice/stream/route"},resolvedPagePath:"/Users/israelwilson/Developer/rhiz-intent-mvp/apps/web/app/api/voice/stream/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:w,headerHooks:b,staticGenerationBailout:g}=f,k="/api/voice/stream/route"},1345:(e,t,r)=>{async function getUserId(){return"demo-user-123"}r.d(t,{n5:()=>getUserId})}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[729,3133,8332,4589,7418,7552,4333,7058,5215,786],()=>__webpack_exec__(56428));module.exports=r})();