"use strict";(()=>{var e={};e.id=7177,e.ids=[7177],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},93961:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>p,originalPathname:()=>w,requestAsyncStorage:()=>l,routeModule:()=>c,serverHooks:()=>d,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>m});var a={};t.r(a),t.d(a,{POST:()=>POST});var o=t(10884),n=t(16132),s=t(95798),i=t(37552);async function POST(e){try{let r=await e.json(),{workspaceId:t,userId:a,action:o,contact:n,source:c}=r;if(!t||!a||!o||!n)return s.Z.json({error:"Missing required fields"},{status:400});switch(await (0,i.v8)(a),o){case"contact.created":case"contact.updated":return await handleContactSync(t,a,n,c);case"contact.deleted":return await handleContactDeletion(t,a,n);default:return s.Z.json({error:"Unsupported action"},{status:400})}}catch(e){return console.error("CRM webhook error:",e),s.Z.json({error:"Internal server error"},{status:500})}}async function handleContactSync(e,r,t,a){try{let o;let n=await i.db.select().from(i.lB).where((0,i.xD)((0,i.eq)(i.lB.workspaceId,e),(0,i.eq)(i.lB.ownerId,r),(0,i.eq)(i.lB.primaryEmail,t.email))).limit(1);if(n.length>0){let[e]=await i.db.update(i.lB).set({fullName:t.fullName||t.firstName+" "+t.lastName,primaryEmail:t.email,location:t.location||t.city,updatedAt:new Date}).where((0,i.eq)(i.lB.id,n[0].id)).returning();o=e.id}else{let[a]=await i.db.insert(i.lB).values({workspaceId:e,ownerId:r,fullName:t.fullName||t.firstName+" "+t.lastName,primaryEmail:t.email,location:t.location||t.city}).returning();o=a.id}return t.company&&await i.db.insert(i.QS).values({workspaceId:e,ownerId:r,subjectType:"person",subjectId:o,key:"company",value:t.company,confidence:95,source:a,lawfulBasis:"legitimate_interest",provenance:{source:"crm_webhook",crmContactId:t.id,crmProvider:a}}),t.title&&await i.db.insert(i.QS).values({workspaceId:e,ownerId:r,subjectType:"person",subjectId:o,key:"role",value:t.title,confidence:95,source:a,lawfulBasis:"legitimate_interest",provenance:{source:"crm_webhook",crmContactId:t.id,crmProvider:a}}),s.Z.json({success:!0,personId:o,action:n.length>0?"updated":"created"})}catch(e){return console.error("Contact sync error:",e),s.Z.json({error:"Failed to sync contact"},{status:500})}}async function handleContactDeletion(e,r,t){try{let a=await i.db.delete(i.lB).where((0,i.xD)((0,i.eq)(i.lB.workspaceId,e),(0,i.eq)(i.lB.ownerId,r),(0,i.eq)(i.lB.primaryEmail,t.email))).returning();return s.Z.json({success:!0,deleted:a.length>0})}catch(e){return console.error("Contact deletion error:",e),s.Z.json({error:"Failed to delete contact"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/crm/route",pathname:"/api/webhooks/crm",filename:"route",bundlePath:"app/api/webhooks/crm/route"},resolvedPagePath:"/Users/israelwilson/Developer/rhiz-intent-mvp/apps/web/app/api/webhooks/crm/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:u,serverHooks:d,headerHooks:p,staticGenerationBailout:m}=c,w="/api/webhooks/crm/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[729,5798,9155,7552],()=>__webpack_exec__(93961));module.exports=t})();